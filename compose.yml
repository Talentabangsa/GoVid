services:
  govid:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: govid
    ports:
      - "${HTTP_PORT:-4101}:4101"
      - "${MCP_PORT:-1106}:1106"
    environment:
      - HTTP_PORT=4101
      - MCP_PORT=1106
      - HTTP_API_KEY=${HTTP_API_KEY}
      - MCP_API_KEY=${MCP_API_KEY}
      - FFMPEG_BINARY=ffmpeg
      - UPLOAD_DIR=/app/uploads
      - OUTPUT_DIR=/app/outputs
      - TEMP_DIR=/app/temp
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-3}
      - JOB_TIMEOUT=${JOB_TIMEOUT:-3600}
    volumes:
      - ./uploads:/app/uploads
      - ./outputs:/app/outputs
      - ./temp:/app/temp
      - ./docs:/app/docs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4101/api/v1/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - govid-network
      - traefik
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # HTTP API Service (port 4101) - Main domain
      - "traefik.http.routers.govid-api.rule=Host(`${DOMAIN:-govid.example.com}`)"
      - "traefik.http.routers.govid-api.entrypoints=websecure"
      - "traefik.http.routers.govid-api.tls=true"
      - "traefik.http.routers.govid-api.tls.certresolver=${CERT_RESOLVER:-letsencrypt}"
      - "traefik.http.routers.govid-api.priority=1"
      - "traefik.http.routers.govid-api.service=govid-api"
      - "traefik.http.services.govid-api.loadbalancer.server.port=4101"
      - "traefik.http.services.govid-api.loadbalancer.healthcheck.path=/api/v1/health"
      - "traefik.http.services.govid-api.loadbalancer.healthcheck.interval=30s"

      # MCP Server Service (port 1106) - /mcp path
      - "traefik.http.routers.govid-mcp.rule=Host(`${DOMAIN:-govid.example.com}`) && PathPrefix(`/mcp`)"
      - "traefik.http.routers.govid-mcp.entrypoints=websecure"
      - "traefik.http.routers.govid-mcp.tls=true"
      - "traefik.http.routers.govid-mcp.tls.certresolver=${CERT_RESOLVER:-letsencrypt}"
      - "traefik.http.routers.govid-mcp.priority=10"
      - "traefik.http.routers.govid-mcp.service=govid-mcp"
      - "traefik.http.services.govid-mcp.loadbalancer.server.port=1106"
      - "traefik.http.services.govid-mcp.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.govid-mcp.loadbalancer.healthcheck.interval=30s"

      # HTTP to HTTPS redirect
      - "traefik.http.routers.govid-http.rule=Host(`${DOMAIN:-govid.example.com}`)"
      - "traefik.http.routers.govid-http.entrypoints=web"
      - "traefik.http.routers.govid-http.middlewares=https-redirect"

      # HTTPS redirect middleware
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"

networks:
  govid-network:
    driver: bridge
  traefik:
    external: true
